{% extends "base.html" %} {% block content %}
<div class="container mt-5">
  <div class="row">
    <div class="col-md-8 offset-md-2">
      <div class="card shadow">
        <div class="card-header bg-primary text-white">
          <h3 class="mb-0">üìù Create New Marketplace Post</h3>
        </div>
        <div class="card-body">
          {% if messages %} {% for message in messages %}
          <div
            class="alert alert-{{ message.tags }} alert-dismissible fade show"
            role="alert"
          >
            {{ message|safe }}
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="alert"
              aria-label="Close"
            ></button>
          </div>
          {% endfor %} {% endif %}

          <form method="post" enctype="multipart/form-data" id="createPostForm">
            {% csrf_token %}

            <!-- Account Selection with Checkboxes -->
            <div class="mb-3">
              <label class="form-label fw-bold">
                Facebook Accounts
                <span id="accountCount" class="badge bg-primary ms-2"
                  >0 selected</span
                >
              </label>
              <div class="border rounded p-3 bg-light">
                <!-- Select All Checkbox -->
                <div class="form-check mb-2 pb-2 border-bottom">
                  <input
                    class="form-check-input"
                    type="checkbox"
                    id="selectAllAccounts"
                  />
                  <label
                    class="form-check-label fw-bold"
                    for="selectAllAccounts"
                  >
                    ‚úÖ Select All Accounts
                  </label>
                </div>

                <!-- Individual Account Checkboxes -->
                {% for account in form.accounts.field.queryset %}
                <div class="form-check mb-2">
                  <input
                    class="form-check-input account-checkbox"
                    type="checkbox"
                    name="accounts"
                    value="{{ account.pk }}"
                    id="account_{{ account.pk }}"
                  />
                  <label
                    class="form-check-label"
                    for="account_{{ account.pk }}"
                  >
                    {{ account.email }}
                  </label>
                </div>
                {% endfor %}
              </div>
              <div class="form-text">
                Select one or more accounts. Post will be created for each
                selected account.
              </div>
              {% if form.accounts.errors %}
              <div class="text-danger mt-2">{{ form.accounts.errors }}</div>
              {% endif %}
              <div
                id="accountError"
                class="text-danger mt-2"
                style="display: none"
              >
                Please select at least one account.
              </div>
            </div>

            <!-- Title -->
            <div class="mb-3">
              <label
                for="{{ form.title.id_for_label }}"
                class="form-label fw-bold"
                >{{ form.title.label }}</label
              >
              {{ form.title }} {% if form.title.errors %}
              <div class="text-danger">{{ form.title.errors }}</div>
              {% endif %}
            </div>

            <!-- Description -->
            <div class="mb-3">
              <label
                for="{{ form.description.id_for_label }}"
                class="form-label fw-bold"
                >{{ form.description.label }}</label
              >
              {{ form.description }} {% if form.description.errors %}
              <div class="text-danger">{{ form.description.errors }}</div>
              {% endif %}
            </div>

            <!-- Price -->
            <div class="mb-3">
              <label
                for="{{ form.price.id_for_label }}"
                class="form-label fw-bold"
                >{{ form.price.label }}</label
              >
              {{ form.price }} {% if form.price.errors %}
              <div class="text-danger">{{ form.price.errors }}</div>
              {% endif %}
            </div>

            <!-- Image Options -->
            <div class="card mb-3">
              <div class="card-header bg-light">
                <h6 class="mb-0">üñºÔ∏è Image Options (Optional)</h6>
              </div>
              <div class="card-body">
                <div class="row">
                  <!-- Option 1: Upload File -->
                  <div class="col-md-6">
                    <label
                      for="{{ form.image.id_for_label }}"
                      class="form-label fw-bold"
                    >
                      üì§ Option 1: Upload Image
                    </label>
                    {{ form.image }}
                    <div class="form-text">{{ form.image.help_text }}</div>
                    {% if form.image.errors %}
                    <div class="text-danger">{{ form.image.errors }}</div>
                    {% endif %}
                  </div>

                  <!-- Option 2: Image URL -->
                  <div class="col-md-6">
                    <label
                      for="{{ form.image_url.id_for_label }}"
                      class="form-label fw-bold"
                    >
                      üåê Option 2: Image URL
                    </label>
                    {{ form.image_url }}
                    <div class="form-text">{{ form.image_url.help_text }}</div>
                    {% if form.image_url.errors %}
                    <div class="text-danger">{{ form.image_url.errors }}</div>
                    {% endif %}
                  </div>
                </div>

                <div class="alert alert-info mt-3 mb-0">
                  <small>
                    <strong>üí° Tip:</strong> You can either upload a file OR
                    provide a URL, not both. Leave both empty if you want to add
                    the image later.
                  </small>
                </div>
              </div>
            </div>

            <div class="alert alert-info">
              <strong>üìå Note:</strong> This post will be created for
              <strong>all selected accounts</strong> and will be scheduled for
              <strong>immediate posting</strong>. If you select 3 accounts, 3
              identical posts will be created.
            </div>

            <div class="d-grid gap-2">
              <button type="submit" class="btn btn-primary btn-lg">
                üì§ Create Post(s)
              </button>
              <a href="{% url 'post_list' %}" class="btn btn-secondary">
                ‚Üê Back to Posts
              </a>
            </div>
          </form>
        </div>
      </div>

      <div class="mt-3">
        <a href="{% url 'bulk_upload_posts' %}" class="btn btn-outline-primary">
          üì¶ Bulk Upload Posts Instead
        </a>
      </div>
    </div>
  </div>
</div>

<script>
  document.addEventListener("DOMContentLoaded", function () {
    const selectAllCheckbox = document.getElementById("selectAllAccounts");
    const accountCheckboxes = document.querySelectorAll(".account-checkbox");
    const form = document.getElementById("createPostForm");
    const accountError = document.getElementById("accountError");
    const accountCount = document.getElementById("accountCount");

    // Update counter display
    function updateCounter() {
      const checkedCount = Array.from(accountCheckboxes).filter(
        (cb) => cb.checked
      ).length;
      const totalCount = accountCheckboxes.length;

      if (checkedCount === 0) {
        accountCount.textContent = "0 selected";
        accountCount.className = "badge bg-secondary ms-2";
      } else if (checkedCount === totalCount) {
        accountCount.textContent = "All " + totalCount + " selected";
        accountCount.className = "badge bg-success ms-2";
      } else {
        accountCount.textContent =
          checkedCount + " of " + totalCount + " selected";
        accountCount.className = "badge bg-primary ms-2";
      }
    }

    // Select All functionality
    selectAllCheckbox.addEventListener("change", function () {
      accountCheckboxes.forEach((checkbox) => {
        checkbox.checked = selectAllCheckbox.checked;
      });
      accountError.style.display = "none";
      updateCounter();
    });

    // Update Select All checkbox based on individual checkboxes
    accountCheckboxes.forEach((checkbox) => {
      checkbox.addEventListener("change", function () {
        const allChecked = Array.from(accountCheckboxes).every(
          (cb) => cb.checked
        );
        const someChecked = Array.from(accountCheckboxes).some(
          (cb) => cb.checked
        );

        selectAllCheckbox.checked = allChecked;
        selectAllCheckbox.indeterminate = someChecked && !allChecked;

        if (someChecked) {
          accountError.style.display = "none";
        }

        updateCounter();
      });
    });

    // Form validation
    form.addEventListener("submit", function (e) {
      const checkedCount = Array.from(accountCheckboxes).filter(
        (cb) => cb.checked
      ).length;

      if (checkedCount === 0) {
        e.preventDefault();
        accountError.style.display = "block";
        accountError.scrollIntoView({ behavior: "smooth", block: "center" });
        return false;
      }
    });

    // Initialize counter
    updateCounter();
  });
</script>

<style>
  .form-check-input:checked {
    background-color: #0d6efd;
    border-color: #0d6efd;
  }
</style>
{% endblock %}
